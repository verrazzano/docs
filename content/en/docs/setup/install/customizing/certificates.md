---
title: "Customize Certificates"
description: "Customize SSL certificate generation for Verrazzano system endpoints"
linkTitle: Certificates
weight: 2
draft: false
---

Verrazzano can be configured to issue certificates to secure access from external clients to system endpoints in
the following configurations:

* Using a certificates issued by a self-signed certificate authority (CA) created by Verrazzano  (the default)
* Using a self-signed certificate authority that you provide  
* Using [LetsEncrypt](https://letsencrypt.org/) as the certificate issuer (requires [OCI DNS](https://docs.cloud.oracle.com/en-us/iaas/Content/DNS/Concepts/dnszonemanagement.htm)).

In both cases, Verrazzano uses [CertManager](https://cert-manager.io/) to 
manage the creation of certificates for use by Verrazzano system components.

{{< alert title="NOTE" color="warning" >}}
Self-signed Certificate Authorities generate certificates that are NOT signed by a trusted authority; they are not typically used in production environments.
{{< /alert >}}

## Use the Verrazzano Self-Signed CA

Verrazzano creates its own self-signed CA as the default behavior.  No configuration is required.

## Use a custom CA

If you wish to provide your own self-signed CA certificate, you must

* (Optional) Create your own signing key pair and CA certificate.
  
  For example, you can use the `openssl` CLI to create a key pair for the `nip.io` domain:
  ```
  # Generate a CA private key
  $ openssl genrsa -out tls.key 2048
    
  # Create a self signed Certificate, valid for 10yrs with the 'signing' option set
  $ openssl req -x509 -new -nodes -key tls.key -subj "/CN=*.nip.io" -days 3650 -reqexts v3_req -extensions v3_ca -out tls.crt
  ```
  The output of these commands will be two files, tls.key and tls.crt, the key and certificate for your signing key pair.
  These files must be named in that manner for the next step.
  
  If you already have generated your own key pair, you should name the private key and certificate `tls.key` and `tls.crt`,
  respectively.
  
* Save your signing key pair as a secret as a Kubernetes secret.

  ```
  $ kubectl create ns myissuer
  $ kubectl create secret myca ca-key-pair \
        --cert=tls.crt \
        --key=tls.key \
        --namespace=myissuer
  ```
  
* Specify the secret name and namespace location in the Verrazzano custom resource.

  The custom CA secret must be provided to CertManager using the following fields in
  [`spec.components.certManager.certificate.ca`](/docs/reference/api/verrazzano/verrazzano#certificate) in the Verrazzano custom resource:
  
  * `spec.components.certManager.certificate.ca.secretName`
  * `spec.components.certManager.certificate.ca.clusterResourceNamespace`

For example, if you created a CA secret named `myca` in the namespace `myissuer`, you would configure it as shown below:

```
apiVersion: install.verrazzano.io/v1alpha1
kind: Verrazzano
metadata:
  name: custom-ca-example
spec:
  profile: dev
  components:
    certManager:
      certificate:
        ca:
          secretName: myca
          clusterResourceNamespace: myissuer
```

## Use LetsEncrypt Certificates

Verrazzano can be configured to use certificates generated by [LetsEncrypt](https://letsencrypt.org/).  LetsEncrypt
implements the [ACME protocol](https://tools.ietf.org/html/rfc8555) which provides a standard protocol for the 
automated issuance of certificates signed by a trusted authority.  This is managed through the 
[`spec.components.certManager.certificate.acme`](/docs/reference/api/verrazzano/verrazzano#acme) 
field in the Verrazzano custom resource.

{{< alert title="NOTE" color="info" >}}
Using LetsEncrypt for certificates also requires using OCI DNS for DNS management.
See the [Customize DNS](/docs/setup/install/customizing/dns/) page for details.
{{< /alert >}}

In order to use configure CertManager to use LetsEncrypt as the certificates provider, you must configure a CertManager 
ACME provider with the following values in the Verrazzano custom resource:

* Set the `spec.components.certManager.certificate.acme.provider` field to `letsEncrypt`.
* Set the `spec.components.certManager.certificate.acme.emailAddress` field to a valid email address for the `letsEncrypt` account
* (Optional) Set the `spec.components.certManager.certificate.acme.environment` field to either `staging` or `production` (the default)

The following example configures Verrazzano to use the LetsEncrypt `production` environment by default with OCI DNS 
for DNS record management:

```
apiVersion: install.verrazzano.io/v1alpha1
kind: Verrazzano
metadata:
  name: letsencrypt-certs-example
spec:
  profile: dev
  components:
    certManager:
      certificate:
        acme:
          provider: letsEncrypt
          emailAddress: jane.doe@mycompany.com
    dns:
      oci:
        ociConfigSecret: oci
        dnsZoneCompartmentOCID: ocid1.compartment.oc1.....
        dnsZoneOCID: ocid1.dns-zone.oc1.....
        dnsZoneName: mydomain.com
```

The following example configures Verrazzano to use the LetsEncrypt `staging` environment with OCI DNS:

```
apiVersion: install.verrazzano.io/v1alpha1
kind: Verrazzano
metadata:
  name: letsencrypt-certs-example
spec:
  profile: dev
  components:
    certManager:
      certificate:
        acme:
          provider: letsEncrypt
          emailAddress: jane.doe@mycompany.com
          environment: staging
    dns:
      oci:
        ociConfigSecret: oci
        dnsZoneCompartmentOCID: ocid1.compartment.oc1.....
        dnsZoneOCID: ocid1.dns-zone.oc1.....
        dnsZoneName: mydomain.com
```

{{< alert title="NOTE" color="warning" >}}
Certificates issued by the LetsEncrypt `staging` environment are signed by untrusted authorities, similar to 
self-signed certificates.  They are not typically used in production environments.
{{< /alert >}}

### LetsEncrypt staging vs production

LetsEncrypt provides rate-limits on generated certificates to ensure fair usage across all clients.  The 
`production` environment limits can be exceeded more frequently in environments where Verrazzano may be being 
installed or reinstalled frequently (like a test environment).  This can result in failed installations due to 
rate limit exceptions on certificate generation. 

In such environments it would be better to use the LetsEncrypt `staging` environment, which has much higher limits
than the `production` environment.  For test environments, the self-signed CA also may be more appropriate to completely
avoid LetsEncrypt rate limits.
